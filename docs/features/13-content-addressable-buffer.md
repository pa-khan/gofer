# 13. Content-Addressable Buffer (Extract to Hash)

## –ö–∞—Ç–µ–≥–æ—Ä–∏—è
–ü—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ (Pro-—É—Ä–æ–≤–µ–Ω—å)

## –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç
üî¥ **P1** (–†–µ–≤–æ–ª—é—Ü–∏–æ–Ω–Ω–∞—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è)

## –û—Ü–µ–Ω–∫–∞ –ø–æ–ª–µ–∑–Ω–æ—Å—Ç–∏ –¥–ª—è AI
‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê (5/5)

## –û–ø–∏—Å–∞–Ω–∏–µ
–†–µ–≤–æ–ª—é—Ü–∏–æ–Ω–Ω–∞—è –∫–æ–Ω—Ü–µ–ø—Ü–∏—è: AI –≤—ã—Ä–µ–∑–∞–µ—Ç/–∫–æ–ø–∏—Ä—É–µ—Ç –±–ª–æ–∫ –∫–æ–¥–∞, –ø–æ–ª—É—á–∞–µ—Ç –∫–æ—Ä–æ—Ç–∫–∏–π —Ö–µ—à-–∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä, –∏ –º–æ–∂–µ—Ç –≤—Å—Ç–∞–≤–ª—è—Ç—å —ç—Ç–æ—Ç –∫–æ–¥ –≤ –ª—é–±–æ–µ –º–µ—Å—Ç–æ –ø—Ä–æ–µ–∫—Ç–∞ —á–µ—Ä–µ–∑ —Ö–µ—à, –Ω–µ —Ö—Ä–∞–Ω—è —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –≤ context window.

## –ü—Ä–æ–±–ª–µ–º–∞
AI –æ–±—ã—á–Ω–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–æ–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–µ –æ–∫–Ω–æ –∫–∞–∫ "–±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞": —á–∏—Ç–∞–µ—Ç —Ñ–∞–π–ª —Ü–µ–ª–∏–∫–æ–º, –∑–∞–ø–æ–º–∏–Ω–∞–µ—Ç –Ω—É–∂–Ω—ã–π –∫—É—Å–æ–∫ –∏ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –µ–≥–æ –∑–∞–Ω–æ–≤–æ –≤ –¥—Ä—É–≥–æ–º —Ñ–∞–π–ª–µ. –≠—Ç–æ:
- –¢—Ä–∞—Ç–∏—Ç –æ–≥—Ä–æ–º–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–æ–∫–µ–Ω–æ–≤
- –ü–æ–≤—ã—à–∞–µ—Ç —Ä–∏—Å–∫ –≥–∞–ª–ª—é—Ü–∏–Ω–∞—Ü–∏–π (–ø–æ—Ç–µ—Ä—è —Å–∏–º–≤–æ–ª–æ–≤, –∑–∞–±—ã—Ç—ã–µ —Å–∫–æ–±–∫–∏)
- –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ—Ç —Ä–∞–∑–º–µ—Ä –ø–µ—Ä–µ–Ω–æ—Å–∏–º—ã—Ö –±–ª–æ–∫–æ–≤ –∫–æ–¥–∞

## –ö–æ–Ω—Ü–µ–ø—Ü–∏—è: Content-Addressable Storage (CAS)
–í–º–µ—Å—Ç–æ —Ç–æ–≥–æ —á—Ç–æ–±—ã AI "–Ω–æ—Å–∏–ª" –∫–æ–¥ –≤ —Å–≤–æ—ë–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ, —Å–µ—Ä–≤–µ—Ä:
1. –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –±–ª–æ–∫ –∫–æ–¥–∞ –≤ –ø–∞–º—è—Ç—å/Redis
2. –í—ã—á–∏—Å–ª—è–µ—Ç —Ö–µ—à –æ—Ç —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ (SHA256 ‚Üí –∫–æ—Ä–æ—Ç–∫–∏–π ID)
3. –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç AI —Ç–æ–ª—å–∫–æ —Ö–µ—à (–Ω–∞–ø—Ä–∏–º–µ—Ä, `a1b2c3d`)
4. AI –æ–ø–µ—Ä–∏—Ä—É–µ—Ç —Ö–µ—à–∞–º–∏, —Å–µ—Ä–≤–µ—Ä —Ä–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞–µ—Ç –∏—Ö –≤ –∫–æ–¥ –ø—Ä–∏ –∑–∞–ø–∏—Å–∏

–≠—Ç–æ –≤–∑—è—Ç–æ –∏–∑ **Git internals** ‚Äî Git —Ç–æ–∂–µ —Ö—Ä–∞–Ω–∏—Ç –¥–∞–Ω–Ω—ã–µ –ø–æ —Ö–µ—à–∞–º.

## –°–∏–≥–Ω–∞—Ç—É—Ä–∞
```
extract_to_hash(path, start_line, end_line, cut) -> HashResult
```

## –ü–∞—Ä–∞–º–µ—Ç—Ä—ã
- `path` (string) ‚Äî –ø—É—Ç—å –∫ —Ñ–∞–π–ª—É
- `start_line` (number) ‚Äî –Ω–∞—á–∞–ª—å–Ω–∞—è —Å—Ç—Ä–æ–∫–∞
- `end_line` (number) ‚Äî –∫–æ–Ω–µ—á–Ω–∞—è —Å—Ç—Ä–æ–∫–∞
- `cut` (boolean) ‚Äî –≤—ã—Ä–µ–∑–∞—Ç—å (—É–¥–∞–ª–∏—Ç—å –∏–∑ —Ñ–∞–π–ª–∞) –∏–ª–∏ —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å

## –í–æ–∑–≤—Ä–∞—â–∞–µ–º–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
```json
{
  "hash_id": "a1b2c3d",
  "size": "2.4 KB",
  "lines": 85,
  "preview": "use std::collections::HashMap;\n\npub struct AuthService {\n...",
  "action": "copied"  // "copied" | "cut"
}
```

## –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

### –ü—Ä–∏–º–µ—Ä 1: –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏
```
AI: read_file_chunk("src/auth.rs", 100, 150)  # –≤–∏–¥–∏—Ç —Ñ—É–Ω–∫—Ü–∏—é authenticate
AI: extract_to_hash("src/auth.rs", start_line=100, end_line=150, cut=false)
Result: {hash_id: "d4e5f6", size: "1.2 KB", lines: 50}

AI: insert_hash("src/modules/auth.rs", line_number=20, hash_id="d4e5f6")
Result: —Ñ—É–Ω–∫—Ü–∏—è –≤—Å—Ç–∞–≤–ª–µ–Ω–∞ –≤ –Ω–æ–≤—ã–π —Ñ–∞–π–ª
```

### –ü—Ä–∏–º–µ—Ä 2: –†–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ ‚Äî –≤—ã—Ä–µ–∑–∞—Ç—å –∏ –≤—Å—Ç–∞–≤–∏—Ç—å
```
AI: extract_to_hash("src/main.rs", start_line=200, end_line=350, cut=true)
Result: {hash_id: "a1b2c3", action: "cut"}  # –±–ª–æ–∫ –≤—ã—Ä–µ–∑–∞–Ω –∏–∑ main.rs

AI: insert_hash("src/utils/helper.rs", line_number=1, hash_id="a1b2c3")
Result: –±–ª–æ–∫ –≤—Å—Ç–∞–≤–ª–µ–Ω –≤ –Ω–æ–≤—ã–π —Ñ–∞–π–ª
```

### –ü—Ä–∏–º–µ—Ä 3: –î–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è ‚Äî –æ–¥–∏–Ω —Ö–µ—à, –º–Ω–æ–≥–æ –≤—Å—Ç–∞–≤–æ–∫
```
AI: extract_to_hash("src/template.rs", start_line=1, end_line=30, cut=false)
Result: {hash_id: "f6e5d4"}  # —à–∞–±–ª–æ–Ω —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω

AI: insert_hash("src/module_a.rs", line_number=1, hash_id="f6e5d4")
AI: insert_hash("src/module_b.rs", line_number=1, hash_id="f6e5d4")
AI: insert_hash("src/module_c.rs", line_number=1, hash_id="f6e5d4")
# –û–¥–∏–Ω –∏ —Ç–æ—Ç –∂–µ –∫–æ–¥ –≤—Å—Ç–∞–≤–ª–µ–Ω –≤ 3 —Ñ–∞–π–ª–∞ –ë–ï–ó –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏!
```

## –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞

### 1. –≠–∫–æ–Ω–æ–º–∏—è —Ç–æ–∫–µ–Ω–æ–≤
**–î–æ:** AI –¥–µ—Ä–∂–∏—Ç –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ 1000 —Å—Ç—Ä–æ–∫ –∫–æ–¥–∞  
**–ü–æ—Å–ª–µ:** AI –æ–ø–µ—Ä–∏—Ä—É–µ—Ç —Ö–µ—à–µ–º –∏–∑ 6 —Å–∏–º–≤–æ–ª–æ–≤

### 2. –£—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ –≥–∞–ª–ª—é—Ü–∏–Ω–∞—Ü–∏–π
**–î–æ:** AI –º–æ–∂–µ—Ç "–∑–∞–±—ã—Ç—å" –∑–∞–∫—Ä—ã–≤–∞—é—â—É—é —Å–∫–æ–±–∫—É –ø—Ä–∏ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–∏  
**–ü–æ—Å–ª–µ:** –°–µ—Ä–≤–µ—Ä —Ö—Ä–∞–Ω–∏—Ç —Ç–æ—á–Ω—É—é –∫–æ–ø–∏—é, –≥–∞–ª–ª—é—Ü–∏–Ω–∞—Ü–∏–∏ –Ω–µ–≤–æ–∑–º–æ–∂–Ω—ã

### 3. –î–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è
–û–¥–∏–Ω–∞–∫–æ–≤—ã–π –∫–æ–¥ ‚Üí –æ–¥–∏–Ω–∞–∫–æ–≤—ã–π —Ö–µ—à. –ï—Å–ª–∏ AI –∫–æ–ø–∏—Ä—É–µ—Ç –æ–¥–∏–Ω –∏ —Ç–æ—Ç –∂–µ —à–∞–±–ª–æ–Ω 10 —Ä–∞–∑, –æ–Ω —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ –ø–∞–º—è—Ç–∏ —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ä–∞–∑.

### 4. –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å
–•–µ—à = –∫—Ä–∏–ø—Ç–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ. AI –Ω–µ –º–æ–∂–µ—Ç "—Å–ª—É—á–∞–π–Ω–æ –∏–∑–º–µ–Ω–∏—Ç—å" —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ö–µ—à–∞.

## –°–≤—è–∑–∞–Ω–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏

### insert_hash(path, line_number, hash_id)
–í—Å—Ç–∞–≤–∏—Ç—å —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ö–µ—à–∞ –≤ —Ñ–∞–π–ª.

### replace_with_hash(path, start_line, end_line, hash_id)
–ó–∞–º–µ–Ω–∏—Ç—å –±–ª–æ–∫ –∫–æ–¥–∞ –Ω–∞ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ö–µ—à–∞.

### content_to_hash(content)
AI –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –∫–æ–¥ –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –Ω–∞ —Å–µ—Ä–≤–µ—Ä –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ö–µ—à–∞.

### list_buffers()
–ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ –∞–∫—Ç–∏–≤–Ω—ã–µ —Ö–µ—à–∏ –≤ –ø–∞–º—è—Ç–∏.

### clear_buffer(hash_id)
–£–¥–∞–ª–∏—Ç—å —Ö–µ—à –∏–∑ –ø–∞–º—è—Ç–∏.

### apply_template(path, template_string)
–ú–æ—â–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è: AI –ø–µ—Ä–µ–¥–∞—ë—Ç —à–∞–±–ª–æ–Ω —Å —Ö–µ—à–∞–º–∏:
```
import { X } from 'Y';
{{hash_a1b2c3}}
export default X;
```
–°–µ—Ä–≤–µ—Ä –∑–∞–º–µ–Ω—è–µ—Ç `{{hash_a1b2c3}}` –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã–π –∫–æ–¥ –∏ –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç —Ñ–∞–π–ª.

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Ö—Ä–∞–Ω–µ–Ω–∏—è

### –í–∞—Ä–∏–∞–Ω—Ç 1: In-Memory (–¥–ª—è –∫–æ—Ä–æ—Ç–∫–∏—Ö —Å–µ—Å—Å–∏–π)
```rust
Arc<DashMap<String, String>>  // hash_id ‚Üí content
```

### –í–∞—Ä–∏–∞–Ω—Ç 2: Redis (–¥–ª—è –ø–µ—Ä—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏)
```
SET hash:a1b2c3d "use std::collections::HashMap;..."
EXPIRE hash:a1b2c3d 86400  # TTL = 24 —á–∞—Å–∞
```

### –í–∞—Ä–∏–∞–Ω—Ç 3: SQLite (–≤ gofer)
```sql
CREATE TABLE buffers (
  hash_id TEXT PRIMARY KEY,
  content TEXT NOT NULL,
  created_at INTEGER,
  expires_at INTEGER,
  size_bytes INTEGER
);
```

## –°–ª–æ–∂–Ω–æ—Å—Ç—å —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏
–í—ã—Å–æ–∫–∞—è (7 –¥–Ω–µ–π)
- –ë–∞–∑–æ–≤—ã–π CAS: —Å—Ä–µ–¥–Ω—è—è (3 –¥–Ω—è)
- –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å file operations: —Å—Ä–µ–¥–Ω—è—è (2 –¥–Ω—è)
- Persistence + TTL: —Å—Ä–µ–¥–Ω—è—è (2 –¥–Ω—è)

## –°—Ç–∞—Ç—É—Å –≤ gofer
‚ùå –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç (—Ä–µ–≤–æ–ª—é—Ü–∏–æ–Ω–Ω–∞—è –∫–æ–Ω—Ü–µ–ø—Ü–∏—è)

## –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
- SHA256 hashing
- Storage backend (in-memory / Redis / SQLite)
- TTL mechanism –¥–ª—è –∞–≤—Ç–æ–æ—á–∏—Å—Ç–∫–∏

## –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤—ã
- AI –¥–µ—Ä–∂–∏—Ç –∫–æ–¥ –≤ context window (–Ω–µ—ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ)
- –í—Ä–µ–º–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã (—Å–ª–æ–∂–Ω–æ —É–ø—Ä–∞–≤–ª—è—Ç—å)

## –°–≤—è–∑–∞–Ω–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
- `insert_hash` ‚Äî –≤—Å—Ç–∞–≤–∫–∞ –∫–æ–¥–∞ –ø–æ —Ö–µ—à—É
- `replace_with_hash` ‚Äî –∑–∞–º–µ–Ω–∞ –±–ª–æ–∫–∞ –Ω–∞ –∫–æ–¥ –ø–æ —Ö–µ—à—É
- `apply_template` ‚Äî —à–∞–±–ª–æ–Ω–∏–∑–∞—Ü–∏—è —Å —Ö–µ—à–∞–º–∏
- `list_buffers` ‚Äî –ø—Ä–æ—Å–º–æ—Ç—Ä –∞–∫—Ç–∏–≤–Ω—ã—Ö —Ö–µ—à–µ–π
- `clear_buffer` ‚Äî –æ—á–∏—Å—Ç–∫–∞ –ø–∞–º—è—Ç–∏

## –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

```toml
[buffer]
# –í–∫–ª—é—á–∏—Ç—å CAS –±—É—Ñ–µ—Ä
enabled = true

# TTL –¥–ª—è —Ö–µ—à–µ–π (–≤ —Å–µ–∫—É–Ω–¥–∞—Ö)
ttl_seconds = 86400  # 24 —á–∞—Å–∞

# –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä –æ–¥–Ω–æ–≥–æ –±—É—Ñ–µ—Ä–∞
max_buffer_size_kb = 1024  # 1 MB

# –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –±—É—Ñ–µ—Ä–æ–≤ –≤ –ø–∞–º—è—Ç–∏
max_buffers = 1000

# Storage backend
storage = "sqlite"  # "memory" | "redis" | "sqlite"
```
