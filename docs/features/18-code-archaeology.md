# 18. Code Archaeology (Function History)

## –ö–∞—Ç–µ–≥–æ—Ä–∏—è
–ê–Ω–∞–ª–∏–∑ –∏—Å—Ç–æ—Ä–∏–∏ –∫–æ–¥–∞

## –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç
üü° **P2** (–ü–æ–ª–µ–∑–Ω–æ)

## –û—Ü–µ–Ω–∫–∞ –ø–æ–ª–µ–∑–Ω–æ—Å—Ç–∏ –¥–ª—è AI
‚≠ê‚≠ê‚≠ê‚≠ê (4/5)

## –û–ø–∏—Å–∞–Ω–∏–µ
–ì–ª—É–±–æ–∫–∏–π –∞–Ω–∞–ª–∏–∑ –∏—Å—Ç–æ—Ä–∏–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–π –∫–æ–¥–∞ –Ω–∞ —É—Ä–æ–≤–Ω–µ —Ñ—É–Ω–∫—Ü–∏–π, —Å—Ç—Ä—É–∫—Ç—É—Ä –∏ –º–æ–¥—É–ª–µ–π.

## –ü—Ä–æ–±–ª–µ–º–∞
AI –≤–∏–¥–∏—Ç —Å—Ç—Ä–∞–Ω–Ω—ã–π –∫—É—Å–æ–∫ –∫–æ–¥–∞ –∏ –Ω–µ –ø–æ–Ω–∏–º–∞–µ—Ç, –∑–∞—á–µ–º –æ–Ω. –í `git_history` –µ—Å—Ç—å –∫–æ–º–º–∏—Ç—ã, –Ω–æ –Ω–µ—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞: "–ø–æ—á–µ–º—É —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫ –¥–æ–±–∞–≤–∏–ª —ç—Ç—É –ø—Ä–æ–≤–µ—Ä–∫—É?", "–∫–æ–≥–¥–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–π —Ä–∞–∑ –º–µ–Ω—è–ª–∞—Å—å —ç—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è?", "–∫—Ç–æ –∞–≤—Ç–æ—Ä —ç—Ç–æ–π –ª–æ–≥–∏–∫–∏?".

## API

### function_history(path, function_name)
–ò—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–∏.

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã:**
- `path` (string) ‚Äî –ø—É—Ç—å –∫ —Ñ–∞–π–ª—É
- `function_name` (string) ‚Äî –∏–º—è —Ñ—É–Ω–∫—Ü–∏–∏

**–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:**
```json
{
  "function": "verify_token",
  "path": "src/auth.rs",
  "changes": [
    {
      "commit": "abc123",
      "date": "2024-01-15",
      "author": "user@example.com",
      "message": "Add exp claim validation",
      "diff": "@@ -42,3 +42,5 @@\n fn verify_token() {\n+    check_expiration();\n }"
    },
    {
      "commit": "def456",
      "date": "2024-03-20",
      "author": "security@example.com",
      "message": "Fix CVE-2024-1234: add issuer validation",
      "diff": "@@ -45,0 +46,2 @@\n+    verify_issuer()?;\n"
    }
  ],
  "total_changes": 5,
  "first_seen": "2023-12-01",
  "last_modified": "2024-03-20"
}
```

**–ü—Ä–∏–º–µ—Ä:**
```
User: "–ü–æ—á–µ–º—É –≤ verify_token –µ—Å—Ç—å –ø—Ä–æ–≤–µ—Ä–∫–∞ issuer?"

AI: function_history("src/auth.rs", "verify_token")
Result: –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∫–æ–º–º–∏—Ç —Å —Å–æ–æ–±—â–µ–Ω–∏–µ–º "Fix CVE-2024-1234: add issuer validation"

AI: "–≠—Ç–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ –±—ã–ª–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞ 20 –º–∞—Ä—Ç–∞ 2024 –¥–ª—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è —É—è–∑–≤–∏–º–æ—Å—Ç–∏ CVE-2024-1234"
```

---

### find_code_in_history(pattern, since, until)
–ü–æ–∏—Å–∫ –ø–æ –∏—Å—Ç–æ—Ä–∏–∏ –∫–æ–º–º–∏—Ç–æ–≤.

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã:**
- `pattern` (string) ‚Äî regex-–ø–∞—Ç—Ç–µ—Ä–Ω –¥–ª—è –ø–æ–∏—Å–∫–∞
- `since` (string, optional) ‚Äî –Ω–∞—á–∞–ª—å–Ω–∞—è –¥–∞—Ç–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, "2024-01-01")
- `until` (string, optional) ‚Äî –∫–æ–Ω–µ—á–Ω–∞—è –¥–∞—Ç–∞

**–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:**
```json
{
  "pattern": "unsafe\\s*\\{",
  "matches": [
    {
      "commit": "abc123",
      "date": "2024-06-15",
      "file": "src/memory.rs",
      "line": 42,
      "context": "unsafe { ptr::read(data) }",
      "status": "removed"
    },
    {
      "commit": "def456",
      "date": "2024-08-20",
      "file": "src/ffi.rs",
      "line": 100,
      "context": "unsafe { libc::free(ptr) }",
      "status": "added"
    }
  ]
}
```

**–ü—Ä–∏–º–µ—Ä:**
```
User: "–ö–æ–≥–¥–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–π —Ä–∞–∑ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª—Å—è unsafe –∫–æ–¥?"

AI: find_code_in_history("unsafe\\s*\\{", since="2024-01-01")
Result: 2 –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è: 1 —É–¥–∞–ª—ë–Ω –≤ –∏—é–Ω–µ, 1 –¥–æ–±–∞–≤–ª–µ–Ω –≤ –∞–≤–≥—É—Å—Ç–µ

AI: "–ü–æ—Å–ª–µ–¥–Ω–µ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ unsafe –±—ã–ª–æ –¥–æ–±–∞–≤–ª–µ–Ω–æ 20 –∞–≤–≥—É—Å—Ç–∞ –≤ src/ffi.rs –¥–ª—è FFI-–∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏"
```

---

### compare_versions(path, version1, version2)
AST-based diff –º–µ–∂–¥—É –¥–≤—É–º—è –≤–µ—Ä—Å–∏—è–º–∏ —Ñ–∞–π–ª–∞.

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã:**
- `path` (string) ‚Äî –ø—É—Ç—å –∫ —Ñ–∞–π–ª—É
- `version1` (string) ‚Äî –±–∞–∑–æ–≤—ã–π –∫–æ–º–º–∏—Ç/—Ç–µ–≥
- `version2` (string) ‚Äî —Ü–µ–ª–µ–≤–æ–π –∫–æ–º–º–∏—Ç/—Ç–µ–≥

**–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:**
```json
{
  "path": "src/api.rs",
  "version1": "v1.0.0",
  "version2": "v2.0.0",
  "structural_changes": {
    "functions_added": ["handle_v2_request", "parse_new_format"],
    "functions_removed": ["legacy_handler"],
    "functions_modified": ["authenticate"],
    "types_added": ["RequestV2"],
    "types_removed": ["RequestV1"]
  },
  "breaking_changes": true,
  "diff": "..."
}
```

**–ü—Ä–∏–º–µ—Ä:**
```
User: "–ß—Ç–æ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å –≤ API –º–µ–∂–¥—É v1.0 –∏ v2.0?"

AI: compare_versions("src/api.rs", "v1.0.0", "v2.0.0")
Result: –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å—Ç—Ä—É–∫—Ç—É—Ä–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è

AI: "–í v2.0 –¥–æ–±–∞–≤–ª–µ–Ω—ã 2 —Ñ—É–Ω–∫—Ü–∏–∏, —É–¥–∞–ª–µ–Ω–∞ legacy_handler, –∏–∑–º–µ–Ω–µ–Ω–∞ authenticate. –û–±–Ω–∞—Ä—É–∂–µ–Ω—ã breaking changes."
```

---

### blame_function(path, function_name)
Blame –¥–ª—è –≤—Å–µ–π —Ñ—É–Ω–∫—Ü–∏–∏ (–Ω–µ –ø–æ—Å—Ç—Ä–æ—á–Ω–æ).

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã:**
- `path` (string) ‚Äî –ø—É—Ç—å –∫ —Ñ–∞–π–ª—É
- `function_name` (string) ‚Äî –∏–º—è —Ñ—É–Ω–∫—Ü–∏–∏

**–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:**
```json
{
  "function": "authenticate",
  "path": "src/auth.rs",
  "original_author": "alice@example.com",
  "original_commit": "abc123",
  "original_date": "2023-05-10",
  "last_modified_by": "bob@example.com",
  "last_modified_commit": "def456",
  "last_modified_date": "2024-11-15",
  "contributors": [
    {"author": "alice@example.com", "lines": 45},
    {"author": "bob@example.com", "lines": 12},
    {"author": "charlie@example.com", "lines": 3}
  ]
}
```

**–ü—Ä–∏–º–µ—Ä:**
```
User: "–ö—Ç–æ –Ω–∞–ø–∏—Å–∞–ª —Ñ—É–Ω–∫—Ü–∏—é authenticate?"

AI: blame_function("src/auth.rs", "authenticate")
Result: –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ –Ω–∞–ø–∏—Å–∞–Ω–∞ alice, –ø–æ—Å–ª–µ–¥–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –æ—Ç bob

AI: "–§—É–Ω–∫—Ü–∏—è –∏–∑–Ω–∞—á–∞–ª—å–Ω–æ –Ω–∞–ø–∏—Å–∞–Ω–∞ alice@example.com 10 –º–∞—è 2023, –ø–æ—Å–ª–µ–¥–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤–Ω–µ—Å–µ–Ω—ã bob@example.com 15 –Ω–æ—è–±—Ä—è 2024"
```

## –ü—Ä–∏–º–µ—Ä—ã –∫–æ–º–ø–ª–µ–∫—Å–Ω–æ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

### –°—Ü–µ–Ω–∞—Ä–∏–π 1: –ê–Ω–∞–ª–∏–∑ legacy –∫–æ–¥–∞
```
User: "–ü–æ—á–µ–º—É –≤ —ç—Ç–æ–π —Ñ—É–Ω–∫—Ü–∏–∏ —Ç–∞–∫–∞—è —Å—Ç—Ä–∞–Ω–Ω–∞—è –ª–æ–≥–∏–∫–∞?"

AI: function_history("src/payment.rs", "calculate_tax")
Result: –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç 8 –∏–∑–º–µ–Ω–µ–Ω–∏–π –∑–∞ 2 –≥–æ–¥–∞

AI: (–∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –∫–æ–º–º–∏—Ç—ã)
AI: "–≠—Ç–∞ –ª–æ–≥–∏–∫–∞ —Ä–∞–∑–≤–∏–≤–∞–ª–∞—Å—å –ø–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ:
     1. 2022-03: –±–∞–∑–æ–≤–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è
     2. 2022-08: –¥–æ–±–∞–≤–ª–µ–Ω–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∞ EU VAT
     3. 2023-03: —Ñ–∏–∫—Å –¥–ª—è UK –ø–æ—Å–ª–µ Brexit
     4. 2023-11: –¥–æ–±–∞–≤–ª–µ–Ω–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∞ –ù–î–° –†–§
     5. 2024-06: –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
     
     –°–ª–æ–∂–Ω–æ—Å—Ç—å –≤—ã–∑–≤–∞–Ω–∞ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç—å—é –ø–æ–¥–¥–µ—Ä–∂–∫–∏ 15 –Ω–∞–ª–æ–≥–æ–≤—ã—Ö —é—Ä–∏—Å–¥–∏–∫—Ü–∏–π."
```

### –°—Ü–µ–Ω–∞—Ä–∏–π 2: –ü–æ–∏—Å–∫ –∫–æ—Ä–Ω—è –ø—Ä–æ–±–ª–µ–º—ã
```
User: "–ö–æ–≥–¥–∞ –±—ã–ª–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ is_admin?"

AI: find_code_in_history("is_admin", since="2020-01-01")
Result: –Ω–∞–π–¥–µ–Ω–æ 3 –¥–æ–±–∞–≤–ª–µ–Ω–∏—è

AI: "–ü—Ä–æ–≤–µ—Ä–∫–∞ is_admin –≤–ø–µ—Ä–≤—ã–µ –¥–æ–±–∞–≤–ª–µ–Ω–∞ –≤ src/auth.rs 15 —è–Ω–≤–∞—Ä—è 2021 –≤ –∫–æ–º–º–∏—Ç–µ 'Add role-based access control'"
```

## –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞

### 1. –ü–æ–Ω–∏–º–∞–Ω–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
AI –≤–∏–¥–∏—Ç –Ω–µ —Ç–æ–ª—å–∫–æ —Ç–µ–∫—É—â–∏–π –∫–æ–¥, –Ω–æ –∏ –∏—Å—Ç–æ—Ä–∏—é –µ–≥–æ —ç–≤–æ–ª—é—Ü–∏–∏.

### 2. –†–∞–±–æ—Ç–∞ —Å legacy
–ö—Ä–∏—Ç–∏—á–Ω–æ –¥–ª—è –ø—Ä–æ–µ–∫—Ç–æ–≤ —Å –º–Ω–æ–≥–æ–ª–µ—Ç–Ω–µ–π –∏—Å—Ç–æ—Ä–∏–µ–π.

### 3. –ê–Ω–∞–ª–∏–∑ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
–ü–æ–∏—Å–∫ –∫–æ–≥–¥–∞ –∏ –ø–æ—á–µ–º—É –±—ã–ª–∏ –¥–æ–±–∞–≤–ª–µ–Ω—ã security checks.

### 4. Blame –Ω–∞ —É—Ä–æ–≤–Ω–µ —Ñ—É–Ω–∫—Ü–∏–π
–ü–æ–Ω–∏–º–∞–Ω–∏–µ –∞–≤—Ç–æ—Ä—Å—Ç–≤–∞ –Ω–∞ —É—Ä–æ–≤–Ω–µ –ª–æ–≥–∏—á–µ—Å–∫–∏—Ö –µ–¥–∏–Ω–∏—Ü, –∞ –Ω–µ –æ—Ç–¥–µ–ª—å–Ω—ã—Ö —Å—Ç—Ä–æ–∫.

## –°–ª–æ–∂–Ω–æ—Å—Ç—å —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏
–°—Ä–µ–¥–Ω—è—è (4-5 –¥–Ω–µ–π)
- –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å git2: –Ω–∏–∑–∫–∞—è (1 –¥–µ–Ω—å)
- –ü–∞—Ä—Å–∏–Ω–≥ AST –¥–ª—è function tracking: —Å—Ä–µ–¥–Ω—è—è (2 –¥–Ω—è)
- Structural diff: —Å—Ä–µ–¥–Ω—è—è (2 –¥–Ω—è)

## –°—Ç–∞—Ç—É—Å –≤ gofer
‚úÖ –ß–∞—Å—Ç–∏—á–Ω–æ: –µ—Å—Ç—å `git_history` –∏ `git_blame`, –Ω–æ –Ω–∞ —É—Ä–æ–≤–Ω–µ —Ñ–∞–π–ª–æ–≤/—Å—Ç—Ä–æ–∫, –Ω–µ —Ñ—É–Ω–∫—Ü–∏–π

## –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
- git2 library (—É–∂–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ gofer)
- Tree-sitter (–¥–ª—è AST-based analysis)
- `get_symbols` (–¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Ñ—É–Ω–∫—Ü–∏–π)

## –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤—ã
- `git_history` + —Ä—É—á–Ω–æ–π –∞–Ω–∞–ª–∏–∑ (–º–µ–Ω–µ–µ —É–¥–æ–±–Ω–æ)
- `git blame` –ø–æ—Å—Ç—Ä–æ—á–Ω–æ (–Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Ñ—É–Ω–∫—Ü–∏—é –∫–∞–∫ –µ–¥–∏–Ω–æ–µ —Ü–µ–ª–æ–µ)
- –í–Ω–µ—à–Ω–∏–π git MCP

## –°–≤—è–∑–∞–Ω–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
- `git_history` ‚Äî –∏—Å—Ç–æ—Ä–∏—è –∫–æ–º–º–∏—Ç–æ–≤ —Ñ–∞–π–ª–∞
- `git_blame` ‚Äî –ø–æ—Å—Ç—Ä–æ—á–Ω–æ–µ –∞–≤—Ç–æ—Ä—Å—Ç–≤–æ
- `get_file_diff` ‚Äî diff –º–µ–∂–¥—É –≤–µ—Ä—Å–∏—è–º–∏
