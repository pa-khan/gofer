# 20. Trash Management (Complete)

## –ö–∞—Ç–µ–≥–æ—Ä–∏—è
–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å—Ç—Ä—É–∫—Ç—É—Ä–æ–π (Management Tools)

## –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç
üî• **P0** (–ö—Ä–∏—Ç–∏—á–Ω–æ)

## –û—Ü–µ–Ω–∫–∞ –ø–æ–ª–µ–∑–Ω–æ—Å—Ç–∏ –¥–ª—è AI
‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê (5/5)

## –û–ø–∏—Å–∞–Ω–∏–µ
–ü–æ–ª–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∫–æ—Ä–∑–∏–Ω–æ–π –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ —É–¥–∞–ª–µ–Ω–∏—è –∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è —Ñ–∞–π–ª–æ–≤.

## –°–≤—è–∑—å —Å –¥—Ä—É–≥–∏–º–∏ —Ñ—É–Ω–∫—Ü–∏—è–º–∏
–≠—Ç–æ —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –¥–ª—è `delete_safe` (—Å–º. `12-delete-safe.md`).

## –í—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ —Å –∫–æ—Ä–∑–∏–Ω–æ–π

### list_trash(filter)
–ü–æ–∫–∞–∑–∞—Ç—å —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –∫–æ—Ä–∑–∏–Ω—ã.

**–§–∏–ª—å—Ç—Ä—ã:**
- `age` ‚Äî `"1h"`, `"24h"`, `"7d"`, `"all"`
- `path_pattern` ‚Äî regex –¥–ª—è –ø–æ–∏—Å–∫–∞ –ø–æ –ø—É—Ç–∏
- `tags` ‚Äî –º–∞—Å—Å–∏–≤ —Ç–µ–≥–æ–≤
- `min_size` / `max_size` ‚Äî —Ñ–∏–ª—å—Ç—Ä –ø–æ —Ä–∞–∑–º–µ—Ä—É

**–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:**
```json
{
  "total_items": 5,
  "total_size": "1.2 MB",
  "items": [
    {
      "deletion_uuid": "d4e5f6...",
      "original_path": "src/auth/legacy.rs",
      "deleted_at": "2h ago",
      "size": "15.4 KB",
      "reason": "Replaced by new auth system",
      "tags": ["refactor"]
    }
  ]
}
```

---

### restore(deletion_uuid, target_path)
–í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ñ–∞–π–ª –∏–∑ –∫–æ—Ä–∑–∏–Ω—ã.

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã:**
- `deletion_uuid` (string) ‚Äî ID —É–¥–∞–ª—ë–Ω–Ω–æ–≥–æ —Ñ–∞–π–ª–∞
- `target_path` (string, optional) ‚Äî –Ω–æ–≤—ã–π –ø—É—Ç—å (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤ –¥—Ä—É–≥–æ–µ –º–µ—Å—Ç–æ)

**–õ–æ–≥–∏–∫–∞:**
1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–∞ –ø–æ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–º—É –ø—É—Ç–∏
2. –ï—Å–ª–∏ –¥–∞ ‚Üí –≤–µ—Ä–Ω—É—Ç—å –æ—à–∏–±–∫—É `conflict`
3. –ï—Å–ª–∏ –Ω–µ—Ç ‚Üí –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ñ–∞–π–ª
4. –£–¥–∞–ª–∏—Ç—å –∏–∑ –∫–æ—Ä–∑–∏–Ω—ã

**–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:**
```json
{
  "status": "restored",
  "path": "src/auth/legacy.rs",
  "size": "15.4 KB"
}
```

---

### purge_trash(filter)
–û–∫–æ–Ω—á–∞—Ç–µ–ª—å–Ω–æ —É–¥–∞–ª–∏—Ç—å –∏–∑ –∫–æ—Ä–∑–∏–Ω—ã.

**–§–∏–ª—å—Ç—Ä—ã:**
- `deletion_uuid` ‚Äî —É–¥–∞–ª–∏—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π —Ñ–∞–π–ª
- `older_than` ‚Äî `"7d"`, `"30d"`, `"all"`
- `tags` ‚Äî —É–¥–∞–ª–∏—Ç—å –≤—Å–µ —Å —Ç–µ–≥–æ–º

**–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:**
```json
{
  "deleted_count": 3,
  "freed_space": "450 KB"
}
```

---

### preview_deleted(deletion_uuid, lines)
–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —É–¥–∞–ª—ë–Ω–Ω–æ–≥–æ —Ñ–∞–π–ª–∞.

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã:**
- `deletion_uuid` (string)
- `lines` (number, optional) ‚Äî —Å–∫–æ–ª—å–∫–æ —Å—Ç—Ä–æ–∫ –ø–æ–∫–∞–∑–∞—Ç—å (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: 50)

**–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:**
```json
{
  "path": "src/auth/legacy.rs",
  "preview": "use std::collections::HashMap;\n\npub fn old_login() {\n...",
  "total_lines": 150,
  "size": "15.4 KB",
  "truncated": true
}
```

---

### diff_with_current(deletion_uuid)
–ü–æ–∫–∞–∑–∞—Ç—å —Ä–∞–∑–Ω–∏—Ü—É –º–µ–∂–¥—É —É–¥–∞–ª—ë–Ω–Ω–æ–π –≤–µ—Ä—Å–∏–µ–π –∏ —Ç–µ–∫—É—â–∏–º —Ñ–∞–π–ª–æ–º.

**–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:**
```json
{
  "status": "conflict",
  "original_path": "src/auth/api.rs",
  "current_exists": true,
  "diff": "@@ -1,10 +1,8 @@\n-old code\n+new code",
  "suggestion": "Use restore_as() to restore under different name"
}
```

---

### restore_multiple(deletion_uuids)
–ú–∞—Å—Å–æ–≤–æ–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —Ñ–∞–π–ª–æ–≤.

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã:**
- `deletion_uuids` (array<string>) ‚Äî —Å–ø–∏—Å–æ–∫ UUID

**–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:**
```json
{
  "total": 3,
  "restored": 2,
  "failed": 1,
  "failures": [
    {
      "deletion_uuid": "abc123",
      "error": "File already exists",
      "original_path": "src/test.rs"
    }
  ]
}
```

---

### search_trash(query, search_in)
–ü–æ–∏—Å–∫ –ø–æ —Å–æ–¥–µ—Ä–∂–∏–º–æ–º—É —É–¥–∞–ª—ë–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤.

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã:**
- `query` (string) ‚Äî —Å—Ç—Ä–æ–∫–∞ –ø–æ–∏—Å–∫–∞
- `search_in` (string) ‚Äî `"filename"` | `"content"` | `"reason"` | `"all"`

**–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:**
```json
{
  "query": "authentication",
  "matches": [
    {
      "deletion_uuid": "d4e5f6",
      "original_path": "src/auth/old.rs",
      "match_type": "content",
      "preview": "pub fn authenticate_user() { ... }"
    }
  ]
}
```

---

### trash_stats()
–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∫–æ—Ä–∑–∏–Ω—ã.

**–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:**
```json
{
  "total_items": 12,
  "total_size": "2.4 MB",
  "oldest_item": {
    "deletion_uuid": "...",
    "deleted_at": "15 days ago",
    "path": "src/old_test.rs"
  },
  "by_tag": {
    "refactor": 8,
    "deprecated": 3,
    "test": 1
  },
  "size_limit": "100 MB",
  "used_percent": 2.4
}
```

---

### auto_cleanup_config(ttl_days, max_size_mb)
–ù–∞—Å—Ç—Ä–æ–∏—Ç—å –∞–≤—Ç–æ–æ—á–∏—Å—Ç–∫—É –∫–æ—Ä–∑–∏–Ω—ã.

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã:**
- `ttl_days` (number) ‚Äî —É–¥–∞–ª—è—Ç—å —Ñ–∞–π–ª—ã —Å—Ç–∞—Ä—à–µ N –¥–Ω–µ–π
- `max_size_mb` (number) ‚Äî –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä –∫–æ—Ä–∑–∏–Ω—ã

**–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:**
```json
{
  "ttl_days": 30,
  "max_size_mb": 500,
  "auto_cleanup_enabled": true,
  "next_cleanup": "2026-03-15T00:00:00Z"
}
```

---

### verify_trash_integrity(deletion_uuid)
–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç—å —É–¥–∞–ª—ë–Ω–Ω–æ–≥–æ —Ñ–∞–π–ª–∞.

**–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:**
```json
{
  "deletion_uuid": "d4e5f6",
  "status": "ok",
  "sha256_match": true,
  "corruption_detected": false
}
```

## –ö–æ–Ω—Ñ–ª–∏–∫—Ç—ã –ø—Ä–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–∏

### restore_as(deletion_uuid, new_name)
–í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø–æ–¥ –¥—Ä—É–≥–∏–º –∏–º–µ–Ω–µ–º (–µ—Å–ª–∏ —Ñ–∞–π–ª —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç).

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã:**
- `deletion_uuid` (string)
- `new_name` (string) ‚Äî –Ω–æ–≤–æ–µ –∏–º—è —Ñ–∞–π–ª–∞

**–ü—Ä–∏–º–µ—Ä:**
```
AI: restore("d4e5f6")
Error: File src/api.rs already exists

AI: restore_as("d4e5f6", "api_old.rs")
Result: –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –∫–∞–∫ src/api_old.rs
```

## CLI –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

```bash
# –ü–æ–∫–∞–∑–∞—Ç—å –∫–æ—Ä–∑–∏–Ω—É
gofer trash list

# –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ñ–∞–π–ª
gofer trash restore <deletion-uuid>

# –û—á–∏—Å—Ç–∏—Ç—å –∫–æ—Ä–∑–∏–Ω—É (—Å—Ç–∞—Ä—à–µ 30 –¥–Ω–µ–π)
gofer trash purge --older-than 30d

# –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
gofer trash stats

# –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —É–¥–∞–ª—ë–Ω–Ω–æ–≥–æ —Ñ–∞–π–ª–∞
gofer trash preview <deletion-uuid>

# –ü–æ–∏—Å–∫ –≤ –∫–æ—Ä–∑–∏–Ω–µ
gofer trash search "authentication"

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç—å
gofer trash verify <deletion-uuid>
```

## –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è–º–∏

–ü—Ä–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏ `delete_safe()` –≤–Ω—É—Ç—Ä–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏:

```rust
AI: begin_transaction("refactor")
AI: delete_safe("src/old.rs", reason="...", tags=["refactor"])
AI: commit_transaction("refactor")
# –¢–æ–ª—å–∫–æ —Å–µ–π—á–∞—Å —Ñ–∞–π–ª –ø–µ—Ä–µ–º–µ—â—ë–Ω –≤ trash

AI: begin_transaction("refactor2")
AI: delete_safe("src/old2.rs")
AI: rollback_transaction("refactor2")
# –§–∞–π–ª –ù–ï —É–¥–∞–ª—ë–Ω, –æ—Å—Ç–∞–ª—Å—è –Ω–∞ –º–µ—Å—Ç–µ
```

## –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞

### –ú–µ—Ö–∞–Ω–∏–∑–º TTL
```
–ö–∞–∂–¥—É—é –Ω–æ—á—å –≤ 00:00 (–∏–ª–∏ –ø—Ä–∏ gofer start):
1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤—Å–µ —Ñ–∞–π–ª—ã –≤ trash
2. –£–¥–∞–ª–∏—Ç—å —Ñ–∞–π–ª—ã —Å—Ç–∞—Ä—à–µ ttl_days
3. –ï—Å–ª–∏ —Ä–∞–∑–º–µ—Ä > max_size_mb:
   - –°–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ –¥–∞—Ç–µ —É–¥–∞–ª–µ–Ω–∏—è (oldest first)
   - –£–¥–∞–ª—è—Ç—å –ø–æ–∫–∞ —Ä–∞–∑–º–µ—Ä –Ω–µ —Å—Ç–∞–Ω–µ—Ç < max_size_mb
```

### –õ–æ–≥ –∞–≤—Ç–æ–æ—á–∏—Å—Ç–∫–∏
```
~/.gofer/indices/<project-uuid>/trash.log

2026-02-25 00:00:15 [INFO] Auto-cleanup started
2026-02-25 00:00:16 [INFO] Deleted 3 items older than 30 days (freed 450 KB)
2026-02-25 00:00:16 [INFO] Trash size: 2.1 MB / 100 MB (2.1%)
2026-02-25 00:00:16 [INFO] Auto-cleanup completed
```

## –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

```toml
[trash]
# –í–∫–ª—é—á–∏—Ç—å –º—è–≥–∫–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ
enabled = true

# TTL –¥–ª—è –∞–≤—Ç–æ–æ—á–∏—Å—Ç–∫–∏ (–¥–Ω–∏)
auto_cleanup_days = 30

# –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä –∫–æ—Ä–∑–∏–Ω—ã (MB)
max_size_mb = 500

# –£–¥–∞–ª—è—Ç—å —Å–∞–º—ã–µ —Å—Ç–∞—Ä—ã–µ –ø—Ä–∏ –ø—Ä–µ–≤—ã—à–µ–Ω–∏–∏ –ª–∏–º–∏—Ç–∞
auto_purge_on_limit = true

# –ò–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞—Ç—å –æ–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã (–Ω–µ –ø–æ–º–µ—â–∞—Ç—å –≤ –∫–æ—Ä–∑–∏–Ω—É)
ignore_patterns = [
    "*.tmp",
    "*.log",
    "node_modules/**",
]

# –í—Ä–µ–º—è –∞–≤—Ç–æ–æ—á–∏—Å—Ç–∫–∏
cleanup_schedule = "00:00"  # –∫–∞–∂–¥—É—é –Ω–æ—á—å –≤ –ø–æ–ª–Ω–æ—á—å
```

## –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –¥–ª—è AI

| –°—Ü–µ–Ω–∞—Ä–∏–π | –†–µ—à–µ–Ω–∏–µ |
|----------|---------|
| AI —Å–ª—É—á–∞–π–Ω–æ —É–¥–∞–ª–∏–ª –≤–∞–∂–Ω—ã–π —Ñ–∞–π–ª | `restore(uuid)` ‚Äî –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞ —Å–µ–∫—É–Ω–¥—É |
| AI –Ω–µ —É–≤–µ—Ä–µ–Ω, –Ω—É–∂–µ–Ω –ª–∏ —Ñ–∞–π–ª | `delete_safe()` ‚Üí –º–æ–∂–µ—Ç –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø–æ–∑–∂–µ |
| –ù—É–∂–Ω–æ –æ—Ç–∫–∞—Ç–∏—Ç—å –±–æ–ª—å—à–æ–π —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ | `restore_multiple([...])` ‚Äî –º–∞—Å—Å–æ–≤–æ–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ |
| –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Ö–æ—á–µ—Ç –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å —É–¥–∞–ª—ë–Ω–Ω—ã–π –∫–æ–¥ | `preview_deleted(uuid)` ‚Äî –ø—Ä–µ–≤—å—é –±–µ–∑ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è |
| –ö–æ—Ä–∑–∏–Ω–∞ —Ä–∞–∑–¥—É–ª–∞—Å—å –¥–æ –≥–∏–≥–∞–±–∞–π—Ç–æ–≤ | `auto_cleanup_config()` + `purge_trash()` |
| AI —Ö–æ—á–µ—Ç –ø–æ–Ω—è—Ç—å, —á—Ç–æ —É–¥–∞–ª–∏–ª –Ω–µ–¥–µ–ª—é –Ω–∞–∑–∞–¥ | `list_trash({age: "7d"})` + —Ç–µ–≥–∏ –¥–ª—è –ø–æ–∏—Å–∫–∞ |
| –§–∞–π–ª –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –Ω–µ–ª—å–∑—è (–∫–æ–Ω—Ñ–ª–∏–∫—Ç) | `diff_with_current()` ‚Üí AI –≤–∏–¥–∏—Ç —Ä–∞–∑–ª–∏—á–∏—è –∏ —Ä–µ—à–∞–µ—Ç |

## –°–ª–æ–∂–Ω–æ—Å—Ç—å —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏
–°—Ä–µ–¥–Ω—è—è (4-5 –¥–Ω–µ–π)
- –ë–∞–∑–æ–≤–∞—è –∫–æ—Ä–∑–∏–Ω–∞ (delete/restore/purge): 2 –¥–Ω—è
- –§–∏–ª—å—Ç—Ä—ã –∏ –ø–æ–∏—Å–∫: 1 –¥–µ–Ω—å
- –ê–≤—Ç–æ–æ—á–∏—Å—Ç–∫–∞ + TTL: 1 –¥–µ–Ω—å
- CLI –∫–æ–º–∞–Ω–¥—ã: 1 –¥–µ–Ω—å

## –°—Ç–∞—Ç—É—Å –≤ gofer
‚ùå –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç

## –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
- filesystem API
- UUID generation
- SHA256 hashing
- git2 (–¥–ª—è metadata)
- cron/scheduler (–¥–ª—è –∞–≤—Ç–æ–æ—á–∏—Å—Ç–∫–∏)

## –°–≤—è–∑–∞–Ω–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
- `delete_safe` ‚Äî –±–∞–∑–æ–≤–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ
- `begin_transaction` ‚Äî –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è–º–∏
- `move_file_or_directory` ‚Äî –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ —Å backup
